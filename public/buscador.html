<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buscador por ID - PAEC</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <h1>Buscador por ID</h1>

    <label for="selectID" class="form-label">Selecciona un ID de proyecto:</label>
    <select id="selectID" class="form-select">
      <option value="">-- Cargando IDs... --</option>
    </select>

    <button id="btnBuscar" class="btn btn-primary" style="margin-top: 15px;">Buscar</button>

    <div id="resultado" style="margin-top: 25px;"></div>

    <a href="index.html" class="btn btn-secondary" style="margin-top: 30px; display: inline-block;">Volver al Menú Principal</a>
  </div>

  <script>
    // Función para cargar todos los IDs disponibles (de proyectos)
    async function cargarIDs() {
      try {
        const res = await fetch('/api/proyectos');
        const proyectos = await res.json();

        const select = document.getElementById('selectID');
        select.innerHTML = '<option value="">-- Selecciona un ID --</option>';

        proyectos.forEach(p => {
          const option = document.createElement('option');
          option.value = p.id;
          option.textContent = p.id + ' - ' + p.titulo;
          select.appendChild(option);
        });
      } catch (error) {
        alert('Error al cargar IDs: ' + error.message);
      }
    }

    // Función para buscar por ID y mostrar resultados combinados
    async function buscarID() {
      const select = document.getElementById('selectID');
      const id = select.value;
      const resultadoDiv = document.getElementById('resultado');
      resultadoDiv.innerHTML = '';

      if (!id) {
        alert('Por favor selecciona un ID.');
        return;
      }

      try {
        const res = await fetch(`/api/buscar/${id}`);
        if (!res.ok) {
          if (res.status === 404) {
            resultadoDiv.innerHTML = `<p>No se encontró información para el ID ${id}.</p>`;
            return;
          }
          throw new Error('Error en la respuesta del servidor');
        }

        const data = await res.json();

        // Mostrar datos del proyecto
        const proyecto = data.proyecto;
        const registros = data.registros;

        if (!proyecto) {
          resultadoDiv.innerHTML = `<p>No se encontró proyecto para el ID ${id}.</p>`;
          return;
        }

        let html = `
          <h2>Proyecto: ${proyecto.titulo} (${proyecto.id})</h2>
          <p><strong>Categoría:</strong> ${proyecto.categoria || 'N/A'}</p>
          <p><strong>Descripción:</strong> ${proyecto.descripcion || 'N/A'}</p>
          <p><strong>Responsable:</strong> ${proyecto.responsable || 'N/A'}</p>
          <p><strong>Participantes:</strong> ${proyecto.participantes || 'N/A'}</p>
          <p><strong>Estatus:</strong> ${proyecto.estatus || 'N/A'}</p>
          <h3>Registros asociados:</h3>
        `;

        if (registros.length === 0) {
          html += '<p>No hay registros asociados a este proyecto.</p>';
        } else {
          html += `<table class="table table-striped">
            <thead>
              <tr>
                <th>Kilos Reciclados</th>
                <th>Lugar</th>
                <th>Fecha de Entrega</th>
                <th>Horario</th>
                <th>Lugar de Recolección</th>
              </tr>
            </thead>
            <tbody>
          `;

          registros.forEach(r => {
            html += `
              <tr>
                <td>${r.kilos_reciclados || 'N/A'}</td>
                <td>${r.lugar || 'N/A'}</td>
                <td>${r.fecha_entrega || 'N/A'}</td>
                <td>${r.horario || 'N/A'}</td>
                <td>${r.lugar_recoleccion || 'N/A'}</td>
              </tr>
            `;
          });

          html += '</tbody></table>';
        }

        resultadoDiv.innerHTML = html;

      } catch (error) {
        resultadoDiv.innerHTML = `<p>Error al buscar: ${error.message}</p>`;
      }
    }

    // Al cargar la página, cargar IDs
    window.onload = cargarIDs;

    document.getElementById('btnBuscar').addEventListener('click', buscarID);
  </script>
</body>
</html>

